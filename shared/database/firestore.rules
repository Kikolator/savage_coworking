rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {
    // true if user is signed in
    function signedIn() {
      return request.auth.uid != null;
    }
    // true if user is client
    function isClient() {
      return request.auth.token.client == true;
    }
    // true if user is admin
    function isAdmin() {
      return request.auth.token.admin == true;
    }
    // true if user is owner
    function isOwner(userId) {
      return request.auth.uid == userId;
    }

    function isValidDeskBookingStatus(status) {
      return status in ['pending', 'confirmed', 'checkedIn', 'completed', 'cancelled', 'noShow'];
    }

    function isValidDeskBookingSource(source) {
      return source in ['app', 'admin', 'system'];
    }

    function durationMinutes(startAt, endAt) {
      return (endAt.toMillis() - startAt.toMillis()) / (1000 * 60);
    }

    function hasValidDeskBookingCoreFields(data) {
      return data.userId is string
        && data.workspaceId is string
        && data.deskId is string
        && data.startAt is timestamp
        && data.endAt is timestamp
        && data.createdAt is timestamp
        && data.updatedAt is timestamp
        && isValidDeskBookingStatus(data.status)
        && isValidDeskBookingSource(data.source)
        && data.endAt.toMillis() > data.startAt.toMillis()
        && durationMinutes(data.startAt, data.endAt) >= 30;
    }

    function hasValidDeskBookingOptionals(data) {
      return (('purpose' in data) ? data.purpose is string && data.purpose.size() <= 140 : true)
        && (('repeatSeriesId' in data) ? data.repeatSeriesId is string && data.repeatSeriesId.size() <= 64 : true)
        && (('cancellationReason' in data) ? data.cancellationReason is string && data.cancellationReason.size() <= 280 : true)
        && (('cancelledBy' in data) ? data.cancelledBy is string : true)
        && (('checkInAt' in data) ? data.checkInAt is timestamp : true)
        && (('checkOutAt' in data) ? data.checkOutAt is timestamp : true)
        && (('cancelledAt' in data) ? data.cancelledAt is timestamp : true);
    }

    function validDeskBookingCreate(data) {
      return hasValidDeskBookingCoreFields(data)
        && hasValidDeskBookingOptionals(data)
        && data.startAt.toMillis() >= request.time.toMillis()
        && data.createdAt == data.updatedAt
        && data.status == 'pending';
    }

    function immutableDeskBookingFields(oldData, newData) {
      return newData.userId == oldData.userId
        && newData.workspaceId == oldData.workspaceId
        && newData.deskId == oldData.deskId
        && newData.startAt == oldData.startAt
        && newData.endAt == oldData.endAt
        && newData.source == oldData.source
        && newData.createdAt == oldData.createdAt;
    }

    function validDeskBookingTransition(oldStatus, newStatus) {
      return (oldStatus == 'pending' && (newStatus == 'confirmed' || newStatus == 'cancelled'))
        || (oldStatus == 'confirmed' && (newStatus == 'checkedIn' || newStatus == 'cancelled'))
        || (oldStatus == 'checkedIn' && (newStatus == 'completed' || newStatus == 'noShow'))
        || newStatus == oldStatus
        || isAdmin();
    }

    function validDeskBookingUpdate(oldData, newData) {
      return hasValidDeskBookingCoreFields(newData)
        && hasValidDeskBookingOptionals(newData)
        && newData.updatedAt >= request.time - duration.value(1, 'm')
        && (isAdmin() || (immutableDeskBookingFields(oldData, newData) && validDeskBookingTransition(oldData.status, newData.status)));
    }

    function isValidSubscriptionStatus(status) {
      return status in ['active', 'cancelled', 'expired', 'trial', 'past_due'];
    }

    function hasValidSubscriptionCoreFields(data) {
      return data.userId is string
        && data.planId is string
        && data.planName is string
        && data.status is string
        && isValidSubscriptionStatus(data.status)
        && data.stripeCustomerId is string
        && data.renewsAutomatically is bool
        && data.currentPeriodStart is timestamp
        && data.currentPeriodEnd is timestamp
        && data.cancelAtPeriodEnd is bool
        && data.deskHours is number
        && data.meetingRoomHours is number
        && data.deskHoursUsed is number
        && data.meetingRoomHoursUsed is number
        && data.createdAt is timestamp
        && data.updatedAt is timestamp
        && data.currentPeriodEnd.toMillis() > data.currentPeriodStart.toMillis()
        && data.deskHours >= 0
        && data.meetingRoomHours >= 0
        && data.deskHoursUsed >= 0
        && data.meetingRoomHoursUsed >= 0;
    }

    function hasValidSubscriptionOptionals(data) {
      return (('stripeSubscriptionId' in data) ? data.stripeSubscriptionId is string : true)
        && (('stripePaymentIntentId' in data) ? data.stripePaymentIntentId is string : true);
    }

    function validSubscriptionCreate(data) {
      return hasValidSubscriptionCoreFields(data)
        && hasValidSubscriptionOptionals(data)
        && data.createdAt == data.updatedAt
        && (data.renewsAutomatically == false || (data.renewsAutomatically == true && 'stripeSubscriptionId' in data && data.stripeSubscriptionId is string))
        && (data.deskHours == 0 || data.deskHoursUsed <= data.deskHours)
        && (data.meetingRoomHours == 0 || data.meetingRoomHoursUsed <= data.meetingRoomHours);
    }

    function immutableSubscriptionFields(oldData, newData) {
      return newData.userId == oldData.userId
        && newData.planId == oldData.planId
        && newData.createdAt == oldData.createdAt;
    }

    function validSubscriptionTransition(oldStatus, newStatus) {
      return (oldStatus == 'trial' && (newStatus == 'active' || newStatus == 'cancelled'))
        || (oldStatus == 'active' && (newStatus == 'past_due' || newStatus == 'cancelled' || newStatus == 'expired'))
        || (oldStatus == 'past_due' && (newStatus == 'active' || newStatus == 'cancelled' || newStatus == 'expired'))
        || (oldStatus == 'cancelled' && newStatus == 'expired')
        || newStatus == oldStatus
        || isAdmin();
    }

    function validSubscriptionUpdate(oldData, newData) {
      return hasValidSubscriptionCoreFields(newData)
        && hasValidSubscriptionOptionals(newData)
        && newData.updatedAt >= request.time - duration.value(1, 'm')
        && immutableSubscriptionFields(oldData, newData)
        && (isAdmin() || validSubscriptionTransition(oldData.status, newData.status))
        && (newData.deskHours == 0 || newData.deskHoursUsed <= newData.deskHours)
        && (newData.meetingRoomHours == 0 || newData.meetingRoomHoursUsed <= newData.meetingRoomHours);
    }

    function isValidSubscriptionInterval(interval) {
      return interval in ['month', 'one_off'];
    }

    function hasValidSubscriptionPlanCoreFields(data) {
      return data.name is string
        && data.name.size() > 0
        && data.name.size() <= 100
        && data.price is int
        && data.price > 0
        && data.currency is string
        && data.currency.size() == 3
        && data.interval is string
        && isValidSubscriptionInterval(data.interval)
        && data.deskHours is number
        && data.meetingRoomHours is number
        && data.deskHours >= 0
        && data.meetingRoomHours >= 0
        && data.features is list
        && data.isActive is bool
        && data.createdAt is timestamp
        && data.updatedAt is timestamp;
    }

    function hasValidSubscriptionPlanOptionals(data) {
      return (('stripePriceId' in data) ? data.stripePriceId is string : true)
        && (('stripeProductId' in data) ? data.stripeProductId is string : true);
    }

    function validSubscriptionPlanCreate(data) {
      return hasValidSubscriptionPlanCoreFields(data)
        && hasValidSubscriptionPlanOptionals(data)
        && data.createdAt == data.updatedAt;
    }

    function validSubscriptionPlanUpdate(oldData, newData) {
      // For updates, we only validate fields that are present
      // (partial updates don't include all fields)
      return newData.updatedAt >= request.time - duration.value(1, 'm')
        && (!('name' in newData) || (newData.name is string && newData.name.size() > 0 && newData.name.size() <= 100))
        && (!('price' in newData) || (newData.price is int && newData.price > 0))
        && (!('currency' in newData) || (newData.currency is string && newData.currency.size() == 3))
        && (!('interval' in newData) || isValidSubscriptionInterval(newData.interval))
        && (!('deskHours' in newData) || (newData.deskHours is number && newData.deskHours >= 0))
        && (!('meetingRoomHours' in newData) || (newData.meetingRoomHours is number && newData.meetingRoomHours >= 0))
        && (!('features' in newData) || newData.features is list)
        && (!('isActive' in newData) || newData.isActive is bool)
        && (!('stripePriceId' in newData) || newData.stripePriceId is string)
        && (!('stripeProductId' in newData) || newData.stripeProductId is string)
        && (!('createdAt' in newData) || newData.createdAt == oldData.createdAt); // createdAt must not change
    }

    // Users collection allows write/read by owner and admin
    match /users/{uid} {
      allow write: if signedIn() && isOwner(uid) || isAdmin();
      allow read: if signedIn() && isOwner(uid) || isAdmin();
    }

    // Member data can be written by owner and read by authenticated users
    match /member_data/{document} {
      allow create: if isOwner(request.resource.data.uid) || isAdmin();
      allow update: if isOwner(resource.data.uid)
        && request.resource.data.uid == resource.data.uid;
      allow read: if signedIn();
    }

    // Meeting Rooms and Desks can be written by admin, and read by authenticated users
    match /meeting_rooms/{document} {
      allow write: if isAdmin();
      allow read: if signedIn();
    }
    match /desks/{document} {
      allow write: if isAdmin();
      allow read: if signedIn();
    }
    match /workspaces/{document} {
      allow write: if isAdmin();
      allow read: if signedIn();
    }

    // checked in out sessions can be written and read by owner
    match /check_in_out_sessions/{document} {
      allow write: if isOwner(request.resource.data.uid) || isAdmin();
      allow read: if isOwner(resource.data.uid) || isAdmin();
    }

    // Bookings can be written and read by owner
    match /bookings/{document} {
      allow create: if isOwner(request.resource.data.member_id) 
        && isClient() 
        || isAdmin();
      allow update: if isOwner(request.resource.data.member_id) 
        && isClient() 
        || isAdmin();
      allow delete: if isAdmin();
      allow get: if isOwner(resource.data.member_id) || isAdmin();
      allow list: if signedIn();
    }

    // Can get ReferralCodes/doc if docId == ownerId
    // ReferralCodes can only be created by admin
    match /referralCodes/{documentId} {
      // allow read: if resource.data.ownerId == documentId;
      allow read: if true;
    } 

    match /deskBookings/{bookingId} {
      allow create: if signedIn()
        && (isOwner(request.resource.data.userId) || isAdmin())
       // && validDeskBookingCreate(request.resource.data);

      allow read: if signedIn()
        && (isOwner(resource.data.userId) || isAdmin());

      allow update: if signedIn()
        && (isAdmin() || isOwner(resource.data.userId))
        && validDeskBookingUpdate(resource.data, request.resource.data);

      allow delete: if isAdmin();
    }

    // Subscriptions collection
    match /subscriptions/{subscriptionId} {
      // Users can read their own subscriptions, admins can read all
      allow read: if signedIn()
        && (isOwner(resource.data.userId) || isAdmin());

      // Users can create their own subscriptions, admins can create any
      allow create: if signedIn()
        && (isOwner(request.resource.data.userId) || isAdmin())
        && validSubscriptionCreate(request.resource.data);

      // Users can update their own subscriptions (limited fields), admins can update any
      allow update: if signedIn()
        && (isAdmin() || isOwner(resource.data.userId))
        && validSubscriptionUpdate(resource.data, request.resource.data);

      // Only admins can delete subscriptions
      allow delete: if isAdmin();
    }

    // Subscription Plans collection
    match /subscriptionPlans/{planId} {
      // All authenticated users can read active plans
      allow read: if signedIn();

      // Only admins can create, update, or delete plans
      allow create: if isAdmin()
        && validSubscriptionPlanCreate(request.resource.data);

      allow update: if isAdmin()
        && validSubscriptionPlanUpdate(resource.data, request.resource.data);

      allow delete: if isAdmin();
    }
  }
}